# Tree Shaking

## 前期配置

这里用的是核心概念里的配置，在 src 目录下创建一个 main.js 文件：

main.js:

```js
export const add = (a, b) => {
    console.log(a + b);
}

export const minus = (a, b) => {
    console.log(a - b);
}
```

修改 index.js，我们导入 add 方法并使用：

```js
import { add } from './main';

add(1, 2);
```

使用 `npx webpack` 命令进行打包，页面正常运行输出。

观察打包完成的输出内容可以看到 main.js 的大小很小，说明的确是按需加载的：

![81223513](http://free-en-01.oss.tusy.xyz/2020125/16772-1uowaun.tns7.png)

最好看一下 main.js 中对应的文件，发现有 `/*! exports provided: add, minus */` 的内容：

![81223514](http://free-en-01.oss.tusy.xyz/2020125/4606-merscc.8eoh.png)

看 eval 中的内容也可以看到。这样就有一个问题，我们只需要 add 方法的内容，可是打包的时候连同 minus 的内容也打包了，这是恨没有必要的，最理想的方法是，我们引入什么，就打包什么，这就需要 `tree shaking`，该概念在 webpack@2.0 后有实现。

## 使用

**Tree Shaking 只支持 ES 的模块导入方式：即 import 的导入和 export 的导出。如果使用 commonJS 就不行。**

原因是 **ES Module** 的导入方式是**静态**的，而 **CommonJS**  的导入方式是**动态**的。

我们当前是开发环境（`mode: 'development'`），要启用 Tree Shaking 需要在 webpack.config.js 中加入以下内容：

```js
optimization: {
    usedExports: true
}
```

该内容可以加载 plugins 后面。

配置 package.json，加上 `"sideEffects": false,`：

```json
{
  "scripts": {
    "start": "webpack-dev-server"
  },
  "sideEffects": false,
  "dependencies": {
      ....
  },
  "devDependencies": {
      ....
  }
}
```

这个命令的意思就是让我们设置不会因为无导出而被忽略的未打包的文件。

如在以前的代码中，我们使用 `@babel/polly-fill` 这种包使用，就要把这个包加到这里来：`"sideEffects": ["@babel/polly-fill"]`。

或者是把 css 文件加到这里：

```js
{
  "scripts": {
    "start": "webpack-dev-server"
  },
  "sideEffects": ["*.css"],
  "dependencies": {
      ....
  },
  "devDependencies": {
      ....
  }
}
```

此时打包，就多了一行 `/*! exports used: add */` ：

![81223515](http://free-en-01.oss.tusy.xyz/2020125/4606-4aicgk.lcj2l.png)

此时模块已经生效，之所以在 eval 中还能找到 minus 的内容，是因为我们是在 `mode: 'development'` 环境下，默认不会去除掉而是提示，以方便我们进行调试。我们在生产环境中：

```js
mode: 'production',
devtool: 'cheap-module-source-map',
```

就会自动去除，且生产环境会自动配置 tree shaking，我们都不需要写

```js
optimization: {
    usedExports: true
}
```

配置项，但是 package 的 `sideEffects` 需要配置。